#!/usr/bin/env node

// TODO: Move to .scripts/js once https://github.com/ClickHouse/click-ui/pull/784 is merged, or create a new PR while waiting for approval to introduce the file architecture change earliest

// TODO: rename scripts? decide if dashes or _ for script naming, maybe best _

import fs from 'fs';
import path from 'path';
import { execSync } from 'child_process';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const LOGOS_DIR = path.join(__dirname, '..', 'src', 'components', 'Logos');
const SYSTEM_DIR = path.join(LOGOS_DIR, 'system');

const toPascalCase = (str) => {
  return str
    .replace(/[-_](.)/g, (_, char) => char.toUpperCase())
    .replace(/^(.)/, (_, char) => char.toUpperCase());
};

const toKebabCase = (str) => {
  return str
    .replace(/([a-z])([A-Z])/g, '$1-$2')
    .replace(/[A-Z]+/g, match => match.toLowerCase())
    .toLowerCase();
};

const getLogoFiles = () => {
  const files = fs.readdirSync(LOGOS_DIR);
  return files
    .filter(file => file.endsWith('.tsx') && file !== 'index.ts')
    .map(file => path.basename(file, '.tsx'));
};

const generateLogoNameType = () => {
  const logoFiles = getLogoFiles();
  const logoNames = logoFiles.map(name => {
    const kebab = toKebabCase(name);
    return `  | '${kebab}'`;
  });

  const typesContent = `import { SVGAttributes } from 'react';
import { ThemeName } from '@/theme';

export type LogoName =
${logoNames.join('\n')};

export type LogoThemeProps = SVGAttributes<SVGElement> & {
  theme?: ThemeName;
};
`;

  fs.writeFileSync(path.join(SYSTEM_DIR, 'types.ts'), typesContent);
};

const convertSvgToComponent = (svgPath, componentName, outputPath) => {
  const svgrConfig = path.join(__dirname, '..', '.svgrrc.mjs');
  const cmd = `npx @svgr/cli --config-file "${svgrConfig}" --typescript "${svgPath}"`;

  let output;
  try {
    output = execSync(cmd, { encoding: 'utf8' });
  } catch (error) {
    console.error(`Failed to convert ${svgPath}:`, error.message);
    process.exit(1);
  }

  output = output.replace(
    /const (\w+) = \(([^)]*)\)/,
    `const ${componentName} = (props: LogoThemeProps)`
  );

  output = output.replace(
    /export default (\w+);$/m,
    `export default ${componentName};`
  );

  output = output.replace(/<svg([^>]*)>/, (match, attrs) => {
    let newAttrs = attrs
      .replace(/width="[^"]*"/, 'width="64"')
      .replace(/height="[^"]*"/, 'height="64"');
    if (!newAttrs.includes('width=')) newAttrs += ' width="64"';
    if (!newAttrs.includes('height=')) newAttrs += ' height="64"';
    return `<svg${newAttrs}>`;
  });

  fs.writeFileSync(outputPath, output);
};

const updateLogosRegistry = (componentName, logoKey, isLight, isDark) => {
  const lightFile = path.join(SYSTEM_DIR, 'LogosLight.ts');
  const darkFile = path.join(SYSTEM_DIR, 'LogosDark.ts');

  if (isLight) {
    let content = fs.readFileSync(lightFile, 'utf8');
    const importLine = `import ${componentName} from '../${componentName}';`;
    if (!content.includes(importLine)) {
      content = content.replace(
        /(import { LogoName } from '\.\/types';)/,
        `${importLine}\n$1`
      );
      content = content.replace(
        /(};\s*export default LogosLight;)/,
        `  '${logoKey}': ${componentName},\n$1`
      );
      fs.writeFileSync(lightFile, content);
    }
  }

  if (isDark) {
    let content = fs.readFileSync(darkFile, 'utf8');
    const importLine = `import ${componentName} from '../${componentName}';`;
    if (!content.includes(importLine)) {
      content = content.replace(
        /(import { LogoName } from '\.\/types';)/,
        `${importLine}\n$1`
      );
      content = content.replace(
        /(};\s*export default LogosDark;)/,
        `  '${logoKey}': ${componentName},\n$1`
      );
      fs.writeFileSync(darkFile, content);
    }
  }
};

const cleanUp = () => {
  ['yarn lint:fix', 'yarn format:fix'].forEach(cmd => {
    try {
      execSync(cmd, { encoding: 'utf8', stdio: 'inherit' });
    } catch (error) {
      console.error(`Failed to run ${cmd}:`, error.message);
    }
  });
}

const args = process.argv.slice(2);

if (args.length < 1) {
  console.error('Error: SVG file path required');
  process.exit(1);
}

const svgPath = args[0];
let componentName = args[1];

if (!componentName) {
  const basename = path.basename(svgPath, '.svg');
  componentName = toPascalCase(basename);
}

if (!componentName.match(/^[A-Z][a-zA-Z0-9]*$/)) {
  console.error('Error: Component name must be PascalCase');
  process.exit(1);
}

const logoKey = toKebabCase(componentName);
const outputPath = path.join(LOGOS_DIR, `${componentName}.tsx`);

convertSvgToComponent(svgPath, componentName, outputPath);
updateLogosRegistry(componentName, logoKey, true, true);
generateLogoNameType();
cleanUp();

console.log(`âœ… Logo conversion completed! Created ${componentName}.tsx`);
