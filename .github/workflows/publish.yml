name: publish

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (version like 0.0.246 or prerelease name like beta/alpha/rc)'
        required: true
        type: string
      branch:
        description: 'Branch to deploy from'
        required: false
        default: 'main'
        type: string

env:
  HUSKY: 0

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Set tag and version type
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.tag }}"
            REF="${{ github.event.inputs.branch }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
            REF="${{ github.event.release.target_commitish }}"
          fi
          echo "GITHUB_TAG=$TAG" >> "$GITHUB_ENV"
          echo "CHECKOUT_REF=$REF" >> "$GITHUB_ENV"
          [[ "$TAG" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-.*)?$ ]] && echo "IS_VERSION_INPUT=true" >> "$GITHUB_ENV" || echo "IS_VERSION_INPUT=false" >> "$GITHUB_ENV"

      - uses: actions/checkout@v4
        with:
          ref: ${{ env.CHECKOUT_REF }}
          token: ${{ secrets.PAT_TOKEN }}
          fetch-depth: 0

      - name: Set package version
        run: |
          if [[ "$IS_VERSION_INPUT" == "true" ]]; then
            npm pkg set version=$GITHUB_TAG
          else
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            IFS='.' read -r MAJOR MINOR PATCH <<< "${LAST_TAG#v}"
            BASE_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"

            LATEST_VERSION=$(npm view @clickhouse/click-ui@${GITHUB_TAG} version 2>/dev/null || echo "")
            if [ -z "$LATEST_VERSION" ]; then
              PRERELEASE_NUM=0
            else
              # Extract base version from latest prerelease
              LATEST_BASE=$(echo "$LATEST_VERSION" | grep -oE "^[0-9]+\.[0-9]+\.[0-9]+" || echo "")

              # If base version changed, reset to 0, otherwise increment
              if [[ "$LATEST_BASE" == "$BASE_VERSION" ]]; then
                PRERELEASE_NUM=$(echo "$LATEST_VERSION" | grep -oE "\.[0-9]+$" | sed 's/\.//')
                PRERELEASE_NUM=$((PRERELEASE_NUM + 1))
              else
                PRERELEASE_NUM=0
              fi
            fi

            NEW_VERSION="${BASE_VERSION}-${GITHUB_TAG}.${PRERELEASE_NUM}"
            echo "Version: $NEW_VERSION"
            npm pkg set version=$NEW_VERSION --no-git-tag-version
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: Setup dependencies
        run: |
          corepack enable
          yarn install --immutable

      - run: yarn test
      - run: yarn build

      - name: Publish to npm
        run: |
          [[ "$IS_VERSION_INPUT" == "false" || "$GITHUB_TAG" =~ (beta|alpha|rc) ]] && NPM_TAG="$GITHUB_TAG" || NPM_TAG="latest"
          npm publish --access public --tag $NPM_TAG --provenance

      - name: Commit and tag version
        if: ${{ env.IS_VERSION_INPUT == 'true' }}
        run: |
          git config user.email "actions@clickhouse.com"
          git config user.name "GitHub Actions"
          git add package.json yarn.lock
          git commit -m "bump version to $GITHUB_TAG"
          git push
          [[ "${{ github.event_name }}" == "workflow_dispatch" ]] && git tag $GITHUB_TAG && git push origin $GITHUB_TAG || true

      - name: Cleanup failed release
        if: ${{ failure() && github.event_name == 'release' }}
        run: |
          echo "::warning::Build failed for release ${{ env.GITHUB_TAG }}"
          echo "Cleaning up release and tag..."
          gh release delete ${{ env.GITHUB_TAG }} --yes --cleanup-tag || true
          echo "::notice::Release deleted. Fix the issue and create a new release."
        env:
          GH_TOKEN: ${{ github.token }}


